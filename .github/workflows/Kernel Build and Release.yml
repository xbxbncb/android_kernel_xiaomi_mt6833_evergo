name: Kernel Build and Release

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'é€‰æ‹©è¦æ„å»ºçš„åˆ†æ”¯'
        required: true
        type: choice
        options:
          - main
          - ksu
        default: main

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm

    # ä¿®å¤1ï¼šæ·»åŠ ç¯å¢ƒå˜é‡å®šä¹‰åˆ†æ”¯å
    env:
      BUILD_BRANCH: ${{ github.event.inputs.branch }}

    steps:
    - name: å‡†å¤‡å†…æ ¸æºç 
      uses: actions/checkout@v4
      with:
        ref: ${{ env.BUILD_BRANCH }}
        fetch-depth: 0

    - name: å®‰è£…æ„å»ºä¾èµ–
      run: |
        apt update && apt install -y \
        bc bison build-essential ccache clang cpio curl flex git \
        gnupg gperf imagemagick libelf-dev liblz4-tool libncurses5-dev \
        libsdl1.2-dev libssl-dev libxml2-utils lzop pngcrush python3 \
        rsync schedtool squashfs-tools xsltproc zip zlib1g-dev \
        gcc-aarch64-linux-gnu g++-aarch64-linux-gnu lld make bash && apt clean  # æ·»åŠ bashå®‰è£…

    - name: é…ç½®ccacheç¼“å­˜
      run: |
        CCACHE_DIR="$GITHUB_WORKSPACE/.ccache"
        mkdir -p "$CCACHE_DIR"
        echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV
        ccache -M 20G
        ccache -o compression=true

    # ä¿®å¤2ï¼šä½¿ç”¨æ­£ç¡®çš„ç¼“å­˜é”®
    - name: ç¼“å­˜ccacheæ•°æ®
      uses: actions/cache@v4
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ${{ runner.os }}-ccache-${{ env.BUILD_BRANCH }}-${{ hashFiles('Makefile') }}  # ä½¿ç”¨å®é™…åˆ†æ”¯å
        restore-keys: |
          ${{ runner.os }}-ccache-${{ env.BUILD_BRANCH }}
          ${{ runner.os }}-ccache-
      id: ccache-cache
      continue-on-error: true

    # ä¿®å¤3ï¼šä½¿ç”¨bashå¹¶ä¿®å¤æ¡ä»¶åˆ¤æ–­
    - name: æ„å»ºå†…æ ¸
      shell: bash  # æŒ‡å®šä½¿ç”¨bash
      run: |
        # ä¿®å¤4ï¼šä½¿ç”¨æ ‡å‡†æµ‹è¯•è¯­æ³•
        if [ "${{ steps.ccache-cache.outputs.cache-hit }}" = "true" ]; then
          echo "â™»ï¸ ccacheç¼“å­˜å‘½ä¸­ï¼ç¼“å­˜çŠ¶æ€:"
          ccache -s
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ°ccacheç¼“å­˜ï¼Œå°†é‡æ–°æ„å»º"
        fi
        
        make ARCH=arm64 CC="ccache clang" CROSS_COMPILE=aarch64-linux-gnu- \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE_COMPAT=aarch64-linux-gnueabi- \
          CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          KCFLAGS="-Wno-unused-but-set-variable -Wno-implicit-function-declaration -Wno-unused-variable -Wno-unused-function -Wno-unused-label" \
          quiet=quiet_ O=out evergo_defconfig
        
        make ARCH=arm64 CC="ccache clang" CROSS_COMPILE=aarch64-linux-gnu- \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE_COMPAT=aarch64-linux-gnueabi- \
          CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          KCFLAGS="-Wno-unused-but-set-variable -Wno-implicit-function-declaration -Wno-unused-variable -Wno-unused-function -Wno-unused-label" \
          quiet=quiet_ O=out -j$(($(nproc) + 1)) 2>&1 | tee build.log
        
        ccache -s
        
    - name: éªŒè¯å†…æ ¸é•œåƒ
      run: |
        if [ ! -f out/arch/arm64/boot/Image.gz-dtb ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°å†…æ ¸é•œåƒæ–‡ä»¶"
          exit 1
        fi
        echo "âœ… éªŒè¯é€šè¿‡ï¼šout/arch/arm64/boot/Image.gz-dtb"
        
        # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        file_size=$(du -h out/arch/arm64/boot/Image.gz-dtb | cut -f1)
        echo "â„¹ï¸ å†…æ ¸é•œåƒå¤§å°: $file_size"

    # ä¿å­˜æ„å»ºæ—¥å¿—ï¼Œå³ä½¿æ„å»ºå¤±è´¥
    - name: æ”¶é›†æ„å»ºæ—¥å¿—
      if: always()
      run: |
        echo "ğŸ“ æ”¶é›†æ„å»ºæ—¥å¿—..."
        mkdir -p build_logs
        
        # ä¿å­˜ä¸»æ„å»ºæ—¥å¿—
        cp build.log build_logs/
        
        # ä¿å­˜é…ç½®æ–‡ä»¶
        [ -f out/.config ] && cp out/.config build_logs/kernel_config || echo "âš ï¸ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶"
        
        # ä¿å­˜å…¶ä»–æ„å»ºæ—¥å¿—
        find out -name "*.log" -exec cp {} build_logs/ \; 2>/dev/null || true
        
        # åˆ›å»ºæ—¥å¿—å‹ç¼©åŒ…
        tar -czvf build_logs.tar.gz build_logs
        echo "âœ… æ„å»ºæ—¥å¿—å·²ä¿å­˜ï¼šbuild_logs.tar.gz"

    # åˆ›å»ºå¯åˆ·å…¥çš„ZIPåŒ…
    - name: åˆ¶ä½œAnyKernel3åˆ·æœºåŒ…
      run: |
        echo "ğŸ“¦ å‡†å¤‡AnyKernel3åˆ·æœºåŒ…..."
        
        # å…‹éš†AnyKernel3ä»“åº“
        git clone --depth=1 https://github.com/cuicanmx/AnyKernel3.git
        
        # å¤åˆ¶å†…æ ¸é•œåƒ
        cp out/arch/arm64/boot/Image.gz-dtb AnyKernel3/
        echo "â„¹ï¸ å†…æ ¸é•œåƒå·²å¤åˆ¶åˆ°AnyKernel3ç›®å½•"
        
        # åˆ›å»ºåˆ·æœºåŒ…
        cd AnyKernel3
        zip -r9 ../anykernel_flashable.zip * > /dev/null
        cd ..
        
        # æ˜¾ç¤ºåˆ·æœºåŒ…ä¿¡æ¯
        zip_size=$(du -h anykernel_flashable.zip | cut -f1)
        echo "âœ… AnyKernel3åˆ·æœºåŒ…åˆ›å»ºå®Œæˆï¼šanykernel_flashable.zip ($zip_size)"

    # æ‰“åŒ…åŸå§‹æ„å»ºäº§ç‰©
    - name: æ‰“åŒ…å†…æ ¸äº§ç‰©
      run: |
        echo "ğŸ“ æ‰“åŒ…å†…æ ¸äº§ç‰©..."
        mkdir -p kernel_artifacts
        
        # åŒ…å«å†…æ ¸é•œåƒ
        cp out/arch/arm64/boot/Image.gz-dtb kernel_artifacts/
        
        # åŒ…å«é…ç½®æ–‡ä»¶
        [ -f out/.config ] && cp out/.config kernel_artifacts/kernel_config
        
        # åˆ›å»ºå‹ç¼©åŒ…
        tar -czvf kernel_artifacts.tar.gz kernel_artifacts
        
        # æ˜¾ç¤ºäº§ç‰©ä¿¡æ¯
        artifact_size=$(du -h kernel_artifacts.tar.gz | cut -f1)
        echo "âœ… å†…æ ¸äº§ç‰©æ‰“åŒ…å®Œæˆï¼škernel_artifacts.tar.gz ($artifact_size)"

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ github.run_id }}
        path: |
          kernel_artifacts.tar.gz
          anykernel_flashable.zip
          build_logs.tar.gz
        retention-days: 7

    - name: è®¾ç½®æ„å»ºæ—¶é—´å’Œæ ‡ç­¾
      run: |
        BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        TAG_SUFFIX=$(date -u +"%Y%m%dT%H%M%SZ")
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        # ä¿®å¤2ï¼šæ ‡ç­¾ä¸­åŒ…å«åˆ†æ”¯å
        echo "TAG_NAME=${{ github.event.inputs.branch }}-kernel-$TAG_SUFFIX" >> $GITHUB_ENV
        echo "â„¹ï¸ ç”Ÿæˆçš„å‘å¸ƒæ ‡ç­¾: $TAG_NAME"

    - name: å‘å¸ƒç‰ˆæœ¬
      # ä¿®å¤3ï¼šæ‰€æœ‰åˆ†æ”¯éƒ½å‘å¸ƒï¼Œä½†å†…å®¹ä¸åŒ
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.TAG_NAME }}
        # ä¿®å¤4ï¼šå‘å¸ƒåç§°åŒ…å«åˆ†æ”¯å
        name: "${{ github.event.inputs.branch }} å†…æ ¸æ„å»º #${{ github.run_number }}"
        # ä¿®å¤5ï¼šåˆ†æ”¯ç‰¹å®šçš„å‘å¸ƒå†…å®¹
        body: |
          ### ğŸš€ å†…æ ¸æ„å»ºè¯¦æƒ…
          - **æ„å»ºåˆ†æ”¯**: ${{ github.event.inputs.branch }}
          - **æ„å»ºæ—¥æœŸ**: ${{ env.BUILD_DATE }}
          - **æ„å»ºæ—¥å¿—**: [build_logs.tar.gz](build_logs.tar.gz)
          - **æ„å»ºID**: ${{ github.run_id }}
          - **å‘å¸ƒæ ‡ç­¾**: ${{ env.TAG_NAME }}
          
          ### ğŸ“² å®‰è£…è¯´æ˜
          1. ä¸‹è½½ `anykernel_flashable.zip`
          2. é‡å¯è¿›å…¥æ¢å¤æ¨¡å¼ (æ¨èä½¿ç”¨TWRP)
          3. åˆ·å…¥ZIPæ–‡ä»¶
          4. é‡å¯ç³»ç»Ÿ
          
          ### ğŸ“ æ„å»ºäº§ç‰©
          - `kernel_artifacts.tar.gz`: åŸå§‹å†…æ ¸äº§ç‰© (åŒ…å«å†…æ ¸é•œåƒå’Œé…ç½®æ–‡ä»¶)
          - `anykernel_flashable.zip`: å¯ç›´æ¥åˆ·å…¥çš„åˆ·æœºåŒ…
          
          ### â„¹ï¸ æ³¨æ„äº‹é¡¹
          - **${{ github.event.inputs.branch }} åˆ†æ”¯ç‰¹æ€§**:
            ${{ github.event.inputs.branch == 'main' && 'â€¢ ç¨³å®šç‰ˆæœ¬\nâ€¢ ç»è¿‡å®Œæ•´æµ‹è¯•' || 'â€¢ å®éªŒæ€§åŠŸèƒ½\nâ€¢ åŒ…å«æœ€æ–°ç‰¹æ€§' }}
          - è¯·ç¡®ä¿è®¾å¤‡å…¼å®¹æ€§åå†åˆ·å…¥
          - åˆ·æœºå‰å»ºè®®å¤‡ä»½é‡è¦æ•°æ®
        files: |
          kernel_artifacts.tar.gz
          anykernel_flashable.zip
          build_logs.tar.gz
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

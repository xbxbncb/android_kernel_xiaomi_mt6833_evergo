name: Kernel Build and Release

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      include_ksu:
        description: "é›†æˆKernelSUæ”¯æŒ"
        required: true
        type: boolean
        default: false
      kernel_branch:
        description: "å†…æ ¸æºç åˆ†æ”¯ (é»˜è®¤: ksu)"
        required: false
        type: string
        default: "ksu"
      ksu_repo:
        description: "KernelSUä»“åº“åœ°å€ (é»˜è®¤: https://github.com/tiann/KernelSU)"
        required: false
        type: string
        default: "https://github.com/tiann/KernelSU"

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm  # ä½¿ç”¨Debianç¨³å®šç‰ˆ
      
    # æ·»åŠ è¶…æ—¶è®¾ç½®é˜²æ­¢æŒ‚èµ·
    timeout-minutes: 120

    steps:
    - name: æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      run: |
        echo "ğŸš€ å¼€å§‹å†…æ ¸æ„å»ºå·¥ä½œæµ"
        echo "ğŸ“… æ„å»ºæ—¥æœŸ: $(date)"
        echo "ğŸ”§ å·¥ä½œæµID: $GITHUB_RUN_ID"
        echo "ğŸŒ¿ å†…æ ¸åˆ†æ”¯: ${{ inputs.kernel_branch || 'é»˜è®¤åˆ†æ”¯' }}"
        echo "ğŸ§© KernelSU: ${{ inputs.include_ksu && 'å¯ç”¨' || 'ç¦ç”¨' }}"
        if [ "${{ inputs.include_ksu }}" = "true" ]; then
          echo "ğŸ“¦ KernelSUä»“åº“: ${{ inputs.ksu_repo }}"
        fi

    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²
        ref: ${{ inputs.kernel_branch || 'main' }}
        # æ˜¾ç¤ºæ£€å‡ºä¿¡æ¯
        path: kernel-src
        
    - name: å®‰è£…æ„å»ºä¾èµ–
      run: |
        echo "ğŸ”§ å®‰è£…æ„å»ºä¾èµ–..."
        apt-get update -qq
        apt-get install -y --no-install-recommends \
          bc bison build-essential ccache clang cpio curl flex git \
          gnupg gperf imagemagick libelf-dev liblz4-tool libncurses5-dev \
          libsdl1.2-dev libssl-dev libxml2-utils lzop pngcrush python3 \
          rsync schedtool squashfs-tools xsltproc zip zlib1g-dev \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu lld make
        apt-get clean
        rm -rf /var/lib/apt/lists/*
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        
    - name: è®°å½•å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
      id: kernel_info
      working-directory: kernel-src
      run: |
        KERNEL_COMMIT=$(git rev-parse --short HEAD)
        KERNEL_BRANCH=$(git branch --show-current)
        echo "â„¹ï¸ å†…æ ¸ä¿¡æ¯: åˆ†æ”¯ $KERNEL_BRANCH, æäº¤ $KERNEL_COMMIT"
        echo "KERNEL_COMMIT=$KERNEL_COMMIT" >> $GITHUB_ENV
        echo "KERNEL_BRANCH=$KERNEL_BRANCH" >> $GITHUB_ENV
        echo "::set-output name=commit::$KERNEL_COMMIT"
        echo "::set-output name=branch::$KERNEL_BRANCH"



    # æ·»åŠ KernelSUé›†æˆæ­¥éª¤
    - name: é›†æˆKernelSU
      if: ${{ inputs.include_ksu == true }}
      working-directory: kernel-src
      run: |
        echo "ğŸ§© æ­£åœ¨é›†æˆKernelSU..."
        echo "ğŸ“¦ ä»“åº“åœ°å€: ${{ inputs.ksu_repo }}"
        
        # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§KernelSU
        if [ -d "KernelSU" ]; then
          echo "ğŸ§¹ æ¸…ç†æ—§KernelSUç›®å½•..."
          rm -rf KernelSU
        fi
        
        # å…‹éš†KernelSUä»“åº“
        echo "â¬‡ï¸ å…‹éš†KernelSUä»“åº“..."
        git clone --depth=1 "${{ inputs.ksu_repo }}" KernelSU
        
        # éªŒè¯å…‹éš†ç»“æœ
        if [ $? -ne 0 ] || [ ! -d "KernelSU" ]; then
          echo "âŒ é”™è¯¯ï¼šKernelSUä»“åº“å…‹éš†å¤±è´¥"
          exit 1
        fi
        
        # è·å–KernelSUç‰ˆæœ¬ä¿¡æ¯
        cd KernelSU
        KSU_VERSION=$(git describe --tags 2>/dev/null || git rev-parse --short HEAD)
        cd ..
        echo "âœ… KernelSUé›†æˆæˆåŠŸï¼ç‰ˆæœ¬: $KSU_VERSION"
        echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV

    - name: é…ç½®ccacheç¼“å­˜
      run: |
        echo "âš™ï¸ é…ç½®ccacheç¼“å­˜..."
        # åˆ›å»ºç¼“å­˜ç›®å½•
        CCACHE_DIR="$GITHUB_WORKSPACE/ccache"
        mkdir -p "$CCACHE_DIR"
    
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV
        echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
        echo "CCACHE_COMPRESSLEVEL=6" >> $GITHUB_ENV
        echo "CCACHE_MAXSIZE=20G" >> $GITHUB_ENV
    
        # åˆå§‹åŒ–ccache
        ccache -z
        echo "âœ… ccacheé…ç½®å®Œæˆ (ç›®å½•: $CCACHE_DIR, å¤§å°: 20G)"

    - name: ç¼“å­˜ccacheæ•°æ®
      uses: actions/cache@v4
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ${{ runner.os }}-ccache-${{ env.KERNEL_COMMIT }}
        restore-keys: |
          ${{ runner.os }}-ccache-
      id: ccache-cache

    - name: æ„å»ºå†…æ ¸
      working-directory: kernel-src
      run: |
        # æ˜¾ç¤ºç¼“å­˜çŠ¶æ€
        if [[ "${{ steps.ccache-cache.outputs.cache-hit }}" == 'true' ]]; then
          echo "â™»ï¸ ccacheç¼“å­˜å‘½ä¸­ï¼ç¼“å­˜çŠ¶æ€:"
          ccache -s
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ°ccacheç¼“å­˜ï¼Œå°†é‡æ–°æ„å»º"
        fi
        
        # æ¸…ç†æ„å»ºç¯å¢ƒ
        echo "ğŸ§¹ æ¸…ç†æ„å»ºç¯å¢ƒ..."
        make O=out clean && make O=out mrproper
        
        # é…ç½®å†…æ ¸
        echo "ğŸ› ï¸ å¼€å§‹é…ç½®å†…æ ¸..."
        make ARCH=arm64 CC="ccache clang" CROSS_COMPILE=aarch64-linux-gnu- \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE_COMPAT=aarch64-linux-gnueabi- \
          CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          KCFLAGS="-Wno-unused-but-set-variable -Wno-implicit-function-declaration -Wno-unused-variable -Wno-unused-function -Wno-unused-label" \
          quiet=quiet_ O=out evergo_defconfig
        
        echo "âš™ï¸ å¼€å§‹ç¼–è¯‘å†…æ ¸..."
        make ARCH=arm64 CC="ccache clang" CROSS_COMPILE=aarch64-linux-gnu- \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE_COMPAT=aarch64-linux-gnueabi- \
          CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          KCFLAGS="-Wno-unused-but-set-variable -Wno-implicit-function-declaration -Wno-unused-variable -Wno-unused-function -Wno-unused-label" \
          quiet=quiet_ O=out -j$(($(nproc) + 1)) 2>&1 | tee build.log
        
        # æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡
        echo "ğŸ“Š ç¼–è¯‘å®Œæˆï¼ccacheä½¿ç”¨ç»Ÿè®¡:"
        ccache -s
        echo "âœ… å†…æ ¸ç¼–è¯‘æˆåŠŸï¼"
        
        # è®°å½•ç¼–è¯‘æ—¶é—´
        echo "â±ï¸ ç¼–è¯‘æ—¶é—´ç»Ÿè®¡:"
        grep -E "real|user|sys" build.log || true

    - name: éªŒè¯å†…æ ¸é•œåƒ
      working-directory: kernel-src
      run: |
        echo "ğŸ” éªŒè¯å†…æ ¸é•œåƒ..."
        if [ ! -f out/arch/arm64/boot/Image.gz-dtb ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°å†…æ ¸é•œåƒæ–‡ä»¶"
          echo "âš ï¸ æ„å»ºç›®å½•å†…å®¹:"
          ls -lR out/arch/arm64/boot/ || true
          exit 1
        fi
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        file_size=$(du -h out/arch/arm64/boot/Image.gz-dtb | cut -f1)
        file_info=$(file out/arch/arm64/boot/Image.gz-dtb)
        echo "âœ… å†…æ ¸é•œåƒéªŒè¯é€šè¿‡:"
        echo "ğŸ“ æ–‡ä»¶è·¯å¾„: out/arch/arm64/boot/Image.gz-dtb"
        echo "ğŸ“ å¤§å°: $file_size"
        echo "â„¹ï¸ æ–‡ä»¶ç±»å‹: $file_info"

    - name: æ”¶é›†æ„å»ºæ—¥å¿—
      if: always()
      working-directory: kernel-src
      run: |
        echo "ğŸ“ æ”¶é›†æ„å»ºæ—¥å¿—..."
        mkdir -p build_logs
        
        # ä¿å­˜ä¸»æ„å»ºæ—¥å¿—
        [ -f build.log ] && cp build.log build_logs/ || echo "âš ï¸ ä¸»æ„å»ºæ—¥å¿—ç¼ºå¤±"
        
        # ä¿å­˜é…ç½®æ–‡ä»¶
        [ -f out/.config ] && cp out/.config build_logs/kernel_config || echo "âš ï¸ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶"
        
        # ä¿å­˜å…¶ä»–æ„å»ºæ—¥å¿—
        find out -name "*.log" -exec cp --parents {} build_logs/ \; 2>/dev/null || true
        
        # åˆ›å»ºæ—¥å¿—å‹ç¼©åŒ…
        tar -czvf ../build_logs.tar.gz build_logs
        echo "âœ… æ„å»ºæ—¥å¿—å·²ä¿å­˜: build_logs.tar.gz"

    - name: åˆ¶ä½œAnyKernel3åˆ·æœºåŒ…
      working-directory: kernel-src
      run: |
        echo "ğŸ“¦ åˆ¶ä½œAnyKernel3åˆ·æœºåŒ…..."
        
        # å…‹éš†AnyKernel3ä»“åº“
        git clone --quiet --depth=1 https://github.com/cuicanmx/AnyKernel3.git
        
        # å¤åˆ¶å†…æ ¸é•œåƒ
        cp out/arch/arm64/boot/Image.gz-dtb AnyKernel3/
        echo "âœ… å†…æ ¸é•œåƒå¤åˆ¶å®Œæˆ"
        
        # æ·»åŠ æ„å»ºä¿¡æ¯
        echo "Kernel Version: ${{ env.KERNEL_BRANCH }} (${{ env.KERNEL_COMMIT }})" > AnyKernel3/version
        if [ "${{ inputs.include_ksu }}" = "true" ]; then
          echo "KernelSU Version: ${{ env.KSU_VERSION }}" >> AnyKernel3/version
        fi
        echo "Build Date: $(date)" >> AnyKernel3/version
        
        # åˆ›å»ºåˆ·æœºåŒ…
        cd AnyKernel3
        zip -r9q ../anykernel_flashable.zip *
        cd ..
        
        # æ˜¾ç¤ºåˆ·æœºåŒ…ä¿¡æ¯
        zip_size=$(du -h anykernel_flashable.zip | cut -f1)
        echo "âœ… åˆ·æœºåŒ…åˆ›å»ºå®Œæˆ: anykernel_flashable.zip ($zip_size)"

    - name: æ‰“åŒ…å†…æ ¸äº§ç‰©
      working-directory: kernel-src
      run: |
        echo "ğŸ“ æ‰“åŒ…å†…æ ¸äº§ç‰©..."
        mkdir -p kernel_artifacts
        
        # åŒ…å«å†…æ ¸é•œåƒ
        cp out/arch/arm64/boot/Image.gz-dtb kernel_artifacts/
        
        # åŒ…å«é…ç½®æ–‡ä»¶
        [ -f out/.config ] && cp out/.config kernel_artifacts/kernel_config
        
        # åˆ›å»ºå‹ç¼©åŒ…
        tar -czvf ../kernel_artifacts.tar.gz kernel_artifacts
        
        # æ˜¾ç¤ºäº§ç‰©ä¿¡æ¯
        artifact_size=$(du -h ../kernel_artifacts.tar.gz | cut -f1)
        echo "âœ… å†…æ ¸äº§ç‰©æ‰“åŒ…å®Œæˆ: kernel_artifacts.tar.gz ($artifact_size)"

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ github.run_id }}
        path: |
          build_logs.tar.gz
          anykernel_flashable.zip
          kernel_artifacts.tar.gz

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: generate_tag
      run: |
        TAG_SUFFIX=$(date -u +"%Y%m%d")
        echo "TAG_NAME=kernel-$TAG_SUFFIX-${{ env.KERNEL_COMMIT }}" >> $GITHUB_ENV
        echo "â„¹ï¸ ç”Ÿæˆçš„å‘å¸ƒæ ‡ç­¾: $TAG_NAME"

    - name: å‘å¸ƒç‰ˆæœ¬
      if: github.ref == 'refs/heads/main' && success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: "å†…æ ¸æ„å»º #${{ github.run_number }} (${{ env.KERNEL_BRANCH }})"
        body: |
          ### ğŸš€ å†…æ ¸æ„å»ºè¯¦æƒ…
          - **æ„å»ºæ—¥æœŸ**: $(date)
          - **æ„å»ºID**: ${{ github.run_id }}
          - **å‘å¸ƒæ ‡ç­¾**: ${{ env.TAG_NAME }}
          - **å†…æ ¸åˆ†æ”¯**: ${{ env.KERNEL_BRANCH }}
          - **å†…æ ¸æäº¤**: [${{ env.KERNEL_COMMIT }}](https://github.com/${{ github.repository }}/commit/${{ env.KERNEL_COMMIT }})
          - **KernelSUæ”¯æŒ**: ${{ inputs.include_ksu && 'æ˜¯' || 'å¦' }}
          ${{ inputs.include_ksu && format('- **KernelSUç‰ˆæœ¬**: {0}', env.KSU_VERSION) || '' }}
          
          ### ğŸ“¦ æ„å»ºäº§ç‰©
          1. `anykernel_flashable.zip` - å¯ç›´æ¥åˆ·å…¥çš„åˆ·æœºåŒ…
          2. `kernel_artifacts.tar.gz` - åŸå§‹å†…æ ¸äº§ç‰©
          3. `build_logs.tar.gz` - å®Œæ•´æ„å»ºæ—¥å¿—
          
          ### ğŸ“² åˆ·æœºæŒ‡å—
          ```bash
          adb reboot recovery
          adb push anykernel_flashable.zip /sdcard/
          # åœ¨æ¢å¤æ¨¡å¼ä¸­åˆ·å…¥zipæ–‡ä»¶
          ```
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - åˆ·æœºå‰è¯·å¤‡ä»½é‡è¦æ•°æ®
          - ä»…é€‚ç”¨äºå…¼å®¹è®¾å¤‡
          - é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´
        files: |
          build_logs.tar.gz
          anykernel_flashable.zip
          kernel_artifacts.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æ¸…ç†å·¥ä½œåŒº
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†å·¥ä½œåŒº..."
        # ä¿ç•™ccacheç›®å½•
        rm -rf kernel-src
        echo "âœ… æ¸…ç†å®Œæˆ"

name: Kernel Build and Release

on:
  workflow_dispatch:  # 手动触发
    inputs:
      branch:
        description: '选择要构建的分支'
        required: true
        type: choice
        options:
          - main
          - ksu
        default: main

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm  # 使用Debian稳定版

    steps:


    - name: 生成发布标签
      id: generate_tag
      run: |
          TAG_SUFFIX=$(date -u +"%Y%m%dT%H%M%SZ")
          echo "TAG_NAME=kernel-$TAG_SUFFIX" >> $GITHUB_ENV
          echo "ℹ️ 生成的发布标签: kernel-$TAG_SUFFIX"
    - name: 设置当前时间
      id: date
      run: echo "CURRENT_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV

    - name: 发布版本
      if: ${{ github.event.inputs.branch == 'main' && success() }}
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.TAG_NAME }}  # 使用上面生成的标签
        name: "内核构建 #${{ github.run_number }} (${{ env.TAG_NAME }})"
        body: |
          ### 🚀 内核构建详情
          - **构建日期**: ${{ env.CURRENT_DATE }}  # 使用环境变量
          - **构建日志**: [build_logs.tar.gz](build_logs.tar.gz)
          - **构建ID**: ${{ github.run_id }}
          - **发布标签**: ${{ env.TAG_NAME }}
          
          ### 📲 安装说明
          1. 下载 `anykernel_flashable.zip`
          2. 重启进入恢复模式 (推荐使用TWRP)
          3. 刷入ZIP文件
          4. 重启系统
          
          ### 📁 构建产物
          - `kernel_artifacts.tar.gz`: 原始内核产物 (包含内核镜像和配置文件)
          - `anykernel_flashable.zip`: 可直接刷入的刷机包
          
          ### ℹ️ 注意事项
          - 请确保设备兼容性后再刷入
          - 刷机前建议备份重要数据
        files: |
          kernel_artifacts.tar.gz
          anykernel_flashable.zip
          build_logs.tar.gz
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        

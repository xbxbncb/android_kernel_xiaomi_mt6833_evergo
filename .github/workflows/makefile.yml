name: Auto Kernel Builer
on:
   push:
      branches: [main,ksu]
   workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix: 
        branch: ['main', 'ksu']
      fail-fast: false
    timeout-minutes: 45
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_MAXSIZE: 20G
      ARCH: arm64
      SUBARCH: arm

    steps:
    - name: Checkout ${{ matrix.branch }} branch Code
      uses: actions/checkout@v4
      with:
        ref: ${{ matrix.branch }}

    - name: Install Dependencies & toolchain
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          clang \
          lld \
          libssl-dev \
          libelf-dev \
          flex \
          bison \
          bc \
          ccache \
          curl \
          git \
          gnupg \
          gperf \
          imagemagick \
          liblz4-tool \
          libncurses6 \
          libncurses5-dev \
          libsdl1.2-dev \
          libxml2 \
          libxml2-utils \
          lzop \
          pngcrush \
          rsync \
          schedtool \
          squashfs-tools \
          xsltproc \
          zip \
          zlib1g-dev \
          gcc-aarch64-linux-gnu

    - name: Configure ccache
      run: |
        mkdir -p $CCACHE_DIR
        echo "max_size = $CCACHE_MAXSIZE"
        sudo chmod -R 777 $CCACHE_DIR

    - name: Restore ccache
      uses: actions/cache@v3
      with:
        path: ${{ env.CCACHE_DIR }}
        key: kernel-ccache-${{ runner.os }}-${{ env.ARCH }}-${{ matrix.branch }}
    
    - name: Build Kernel (ARM64 Cross-Compile)
      run: |
        make -j32 O=out \
          CC="ccache clang" \
          LD=ld.lld \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE=aarch64-linux-gnu- \
          CROSS_COMPILE_COMPAT=aarch64-linux-gnueabi- \
          CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          LLVM_IAS=1 \
          KCFLAGS="--target=aarch64-linux-gnu \
                   -Wno-unused-but-set-variable \
                   -Wno-implicit-function-declaration \
                   -Wno-unused-variable -Wno-unused-function -Wno-unused-label" \
          evergo_defconfig

        make -j32 O=out \
          CC="ccache clang" \
          LD=ld.lld \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE=aarch64-linux-gnu- \
          CROSS_COMPILE_COMPAT=aarch64-linux-gnueabi- \
          CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          LLVM_IAS=1 \
          KCFLAGS="--target=aarch64-linux-gnu \
                   -Wno-unused-but-set-variable \
                   -Wno-implicit-function-declaration \
                   -Wno-unused-variable -Wno-unused-function -Wno-unused-label"

    - name: Package Kernel
      run: |
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git 
        cp out/arch/arm64/boot/Image.gz-dtb AnyKernel3/
        zip -r9 AnyKernel3-${{ matrix.branch }}.zip AnyKernel3/*
        
    - name: Upload AnyKernel3.zip
      uses: actions/upload-artifact@v4
      with:
        name: AnyKernel3-${{ matrix.branch }}
        path: AnyKernel3-${{ matrix.branch }}.zip
    
    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: generate_tag
      run: |
          TAG_SUFFIX=$(date -u +"%Y%m%dT%H%M%SZ")
          echo "TAG_NAME=kernel-$TAG_SUFFIX" >> $GITHUB_ENV
          echo "â„¹ï¸ ç”Ÿæˆçš„å‘å¸ƒæ ‡ç­¾: kernel-$TAG_SUFFIX"

    - name: å‘å¸ƒç‰ˆæœ¬
      if: github.ref == 'refs/heads/main' && success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.TAG_NAME }}  # ä½¿ç”¨ä¸Šé¢ç”Ÿæˆçš„æ ‡ç­¾
        name: "å†…æ ¸æ„å»º #${{ github.run_number }} (${{ env.TAG_NAME }})"
        body: |
          ### ğŸš€ å†…æ ¸æ„å»ºè¯¦æƒ…
          - **æ„å»ºæ—¥æœŸ**: $(date)
          - **æ„å»ºæ—¥å¿—**: [build_logs.tar.gz](build_logs.tar.gz)
          - **æ„å»ºID**: ${{ github.run_id }}
          - **å‘å¸ƒæ ‡ç­¾**: ${{ env.TAG_NAME }}
          
          ### ğŸ“² å®‰è£…è¯´æ˜
          1. ä¸‹è½½ `anykernel_flashable.zip`
          2. é‡å¯è¿›å…¥æ¢å¤æ¨¡å¼ (æ¨èä½¿ç”¨TWRP)
          3. åˆ·å…¥ZIPæ–‡ä»¶
          4. é‡å¯ç³»ç»Ÿ
          
          ### ğŸ“ æ„å»ºäº§ç‰©
          - `kernel_artifacts.tar.gz`: åŸå§‹å†…æ ¸äº§ç‰© (åŒ…å«å†…æ ¸é•œåƒå’Œé…ç½®æ–‡ä»¶)
          - `anykernel_flashable.zip`: å¯ç›´æ¥åˆ·å…¥çš„åˆ·æœºåŒ…
          
          ### â„¹ï¸ æ³¨æ„äº‹é¡¹
          - è¯·ç¡®ä¿è®¾å¤‡å…¼å®¹æ€§åå†åˆ·å…¥
          - åˆ·æœºå‰å»ºè®®å¤‡ä»½é‡è¦æ•°æ®
        files: |
          AnyKernel3-${{ matrix.branch }}
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        

    - name: Save ccache
      uses: actions/cache/save@v3
      with:
        path: ${{ env.CCACHE_DIR }}
        key: kernel-ccache-${{ runner.os }}-${{ env.ARCH }}-${{ matrix.branch }}-${{ github.run_id }}
    

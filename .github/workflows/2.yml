name: Kernel Build and Release test1

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm

    steps:
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: å®‰è£…æ„å»ºä¾èµ–ï¼ˆå¸¦ç¼“å­˜ï¼‰
      id: deps-cache
      run: |
        # æ£€æŸ¥ä¾èµ–æ˜¯å¦å·²å®‰è£…
        if [ -f /tmp/deps_installed ]; then
          echo "âœ… ä¾èµ–å·²å®‰è£…"
          exit 0
        fi
        
        # å®‰è£…ä¾èµ–å¹¶æ ‡è®°å®Œæˆ
        apt update && apt install -y \
        bc bison build-essential ccache clang cpio curl flex git \
        gnupg gperf imagemagick libelf-dev liblz4-tool libncurses5-dev \
        libsdl1.2-dev libssl-dev libxml2-utils lzop pngcrush python3 \
        rsync schedtool squashfs-tools xsltproc zip zlib1g-dev \
        gcc-aarch64-linux-gnu g++-aarch64-linux-gnu lld make && apt clean
        
        touch /tmp/deps_installed
      env:
        CACHE_KEY: ${{ runner.os }}-deps-${{ github.ref }}

    - name: é…ç½®ccacheç¼“å­˜
      run: |
        CCACHE_DIR="$GITHUB_WORKSPACE/.ccache"
        mkdir -p "$CCACHE_DIR"
        echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV
        
        ccache -M 20G
        ccache -o compression=true
        echo "â„¹ï¸ ccacheç¼“å­˜å·²é…ç½®ï¼Œç›®å½•: $CCACHE_DIR"

    - name: æ¢å¤ccacheç¼“å­˜
      uses: actions/cache@v4
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ${{ runner.os }}-ccache-${{ github.ref }}
        restore-keys: |
          ${{ runner.os }}-ccache-${{ github.ref }}
          ${{ runner.os }}-ccache-
      id: ccache-cache

    - name: å†…æ ¸é…ç½®ä¸ç¼–è¯‘
      run: |
        echo "ğŸ› ï¸ å¼€å§‹é…ç½®å†…æ ¸..."
        make ARCH=arm64 CC="ccache clang" CROSS_COMPILE=aarch64-linux-gnu- \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE_COMPAT=aarch64-linux-gnueabi- \
          CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          KCFLAGS="-Wno-unused-but-set-variable -Wno-implicit-function-declaration -Wno-unused-variable -Wno-unused-function -Wno-unused-label" \
          quiet=quiet_ O=out evergo_defconfig
        
        echo "âš™ï¸ å¼€å§‹ç¼–è¯‘å†…æ ¸..."
        make ARCH=arm64 CC="ccache clang" CROSS_COMPILE=aarch64-linux-gnu- \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE_COMPAT=aarch64-linux-gnueabi- \
          CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          KCFLAGS="-Wno-unused-but-set-variable -Wno-implicit-function-declaration -Wno-unused-variable -Wno-unused-function -Wno-unused-label" \
          quiet=quiet_ O=out -j$(($(nproc) + 2)) 2>&1 | tee build.log
        
        echo "ğŸ“Š ç¼–è¯‘å®Œæˆï¼ç¼“å­˜ä½¿ç”¨æƒ…å†µ:"
        ccache -s
        echo "âœ… å†…æ ¸ç¼–è¯‘å®Œæˆï¼"

    - name: éªŒè¯æ„å»ºäº§ç‰©
      run: |
        if [ ! -f out/arch/arm64/boot/Image.gz-dtb ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°å†…æ ¸é•œåƒæ–‡ä»¶"
          exit 1
        fi
        
        # éªŒè¯AnyKernel3æ¨¡æ¿å®Œæ•´æ€§
        if [ ! -f AnyKernel3/anykernel.sh ]; then
          echo "âŒ é”™è¯¯ï¼šAnyKernel3æ¨¡æ¿ä¸å®Œæ•´"
          exit 1
        fi

    - name: åˆ¶ä½œåˆ·æœºåŒ…
      run: |
        echo "ğŸ“¦ åˆ›å»ºAnyKernel3åˆ·æœºåŒ…..."
        
        # æ¸…ç†æ—§æ–‡ä»¶
        rm -rf AnyKernel3
        git clone --depth=1 https://github.com/cuicanmx/AnyKernel3.git 
        
        # å¤åˆ¶å†…æ ¸é•œåƒ
        cp out/arch/arm64/boot/Image.gz-dtb AnyKernel3/
        
        # æ·»åŠ æ„å»ºä¿¡æ¯
        cat > AnyKernel3/version << EOF
        Kernel Build: $(date +%Y-%m-%d)
        GitHub Run: $GITHUB_RUN_ID
        Commit SHA: $GITHUB_SHA
        Build URL: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID
        EOF
        
        # æ‰“åŒ…åˆ·æœºåŒ…
        cd AnyKernel3 && zip -r9 ../anykernel_flashable.zip * > /dev/null
        
        echo "âœ… åˆ·æœºåŒ…åˆ›å»ºå®Œæˆ"

    - name: æ”¶é›†æ„å»ºæ—¥å¿—
      if: always()
      run: |
        mkdir -p build_logs
        cp build.log build_logs/
        [ -f out/.config ] && cp out/.config build_logs/kernel_config
        
        # æ”¶é›†ç¼–è¯‘è­¦å‘Šä¿¡æ¯
        grep -i "warning" build.log > build_logs/warnings.txt 2>/dev/null || true
        
        tar -czvf build_logs.tar.gz build_logs
        echo "âœ… æ—¥å¿—å·²å½’æ¡£"

    - name: ç”Ÿæˆå‘å¸ƒå…ƒæ•°æ®
      id: release-info
      run: |
        # ç”Ÿæˆå”¯ä¸€æ ‡ç­¾
        TAG_SUFFIX=$(date -u +"%Y%m%dT%H%M%SZ")
        echo "TAG_NAME=release-$TAG_SUFFIX" >> $GITHUB_ENV
        
        # æå–å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
        KERNEL_VERSION=$(make -s O=out kernelrelease)
        echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
        
        echo "â„¹ï¸ å‘å¸ƒæ ‡ç­¾: $TAG_NAME"
        echo "â„¹ï¸ å†…æ ¸ç‰ˆæœ¬: $KERNEL_VERSION"

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ github.run_id }}
        path: |
          kernel_artifacts.tar.gz
          anykernel_flashable.zip
          build_logs.tar.gz
        retention-days: 14

    - name: åˆ›å»ºGitHubå‘å¸ƒ
      if: github.ref == 'refs/heads/main' && success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: "å†…æ ¸ç‰ˆæœ¬ v${{ env.KERNEL_VERSION }} (${{ env.TAG_NAME }})"
        body: |
          ### ğŸš€ æ„å»ºè¯¦æƒ…
          - **å†…æ ¸ç‰ˆæœ¬**: ${{ env.KERNEL_VERSION }}
          - **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M UTC")
          - **GitHub Action**: [æ„å»ºæ—¥å¿—]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)
          
          ### ğŸ“¦ ä¸‹è½½æ–‡ä»¶
          - `anykernel_flashable.zip`: å¯åˆ·å…¥çš„ROMåŒ…
          - `kernel_artifacts.tar.gz`: åŸå§‹å†…æ ¸é•œåƒåŠé…ç½®
          - `build_logs.tar.gz`: å®Œæ•´æ„å»ºæ—¥å¿—åŠè­¦å‘Šä¿¡æ¯
        files: |
          anykernel_flashable.zip
          kernel_artifacts.tar.gz
          build_logs.tar.gz
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}